\documentclass{article}
% preamble (Packages importieren)

\newcommand{\comment}[1]{}


\author{Eduard Scherer}
\title{Development \& Construction of an Autonomous Path-Following Drone}
\date{\today}
\usepackage[utf8]{inputenc}

\usepackage[
backend=biber,
style=numeric,
sorting=ynt
]{biblatex}
\addbibresource{references.bib} %Imports bibliography file

\usepackage{parskip}

\usepackage{listings}
\lstdefinestyle{BaselineStyle}
{ %
	commentstyle=\color{Blue},
	keywordstyle=\color{Green},
	numberstyle=\tiny\color{Gray},
	stringstyle=\color{Fuchsia},
	basicstyle=\ttfamily,
	columns=flexible,
	breakatwhitespace=false,
	breaklines=true,
	captionpos=b,
	keepspaces=true,
	numbers=left,
	numbersep=5pt,
	showspaces=false,
	showstringspaces=false,
	showtabs=false,
	tabsize=2,
	xleftmargin=1.5em,
	frame=single,
	framexleftmargin=1.5em
} %
% set to 'BaselineStyle'
\lstset{style=BaselineStyle}



% Dokument
\begin{document}
\maketitle
\tableofcontents
	\section{Introduction}
	% TODO introduction
	% do at the end of the writing process
	% maybe a quick explanation of the term "drone"
	% drones are being used in war more and more self-built ones(Blheli32 is dead, because of the use in wars.)
	% article about more and more autonomous drones in the Ukraine-Russia War

	\section{Personal Motivation}
	\comment{rather short}
	\section{Literature Review}
	\subsection{General Software Considerations}
	% TODO {why I choose the software (work around the same topic that already exists)}
	
	There are three main softwares to consider when it comes to drones Betaflight, INAV and Ardupilot. All of them are open source. Multiwii was the origin of Betaflight and INAV. Multwii was Arduino based and then upgraded to Baseflight to be able to use the STM32 chips. Then it was forked to Cleanflight, which was later forked again into Betaflight and INAV\cite{history}. 
	
	The following three paragraphs are mostly based on \cite{firmwarearticle} and \cite{firmwarevideo}.
	
	Betaflight is in general the go-to option for first person view drones, commonly known as FPV drones, for either filming or racing. It is the most beginner friendly out of the three, because it has a large community, which results in a wide range of tutorials. When a new board comes out it is normally made to be used with Betaflight. However Betaflight lacks the option for different types of vehicles and generally the automated features are less developed compared to the other two. 
	
	INAV offers basic autonomous flight using waypoints and automated landing. It does not only support quadcopters, but also boats, rovers, planes and wings. It has a similar interface to Betaflight so switching from one to the other is easier than switching to Ardupilot.
	
	Ardupilot basically offers everything the other two have to offer and more for example Submarines and VTOLs. It is not commonly used with FPV, yet you can if you want to. It is more complicated to get into, but as a trade off you will be able to customize everything to your will. It is also the only option for a companion computer like the RaspberryPi. A few years ago it was really expensive to start, because it only supported the Pixhawk family of flight controllers which cost several hundred Franks a piece. However in recent years it has began to support more and cheaper flight controllers.
	
	
	
	
	
	
	\section{Methodology}
	% TODO {(only what has been done + which parts are needed and why I choose them)}
	\subsection{Drone Overview}
	If you want to fly a drone you have two options available either you buy one or you built one. The second option is for people who are interested in tinkering with their electronics until they work, not only the better option but also the cheaper one.
	
	The main parts needed for a drone are the flight controller(Fc), the electronic speed controller(ESC), the receiver, the battery and of course the frame, in addition you can also add a GPS, LEDs and more. The flight controller and electronic speed controller are referred to as Fc and ESC. The Fc runs the chosen software and controls every other part in one way or another. It is directly connected to the ESC, which controls the motors and is connected to the battery. The Fc also communicates with the receiver and GPS if there is one. In my case there is also a RaspberryPi which also connects to the Fc.
	% TODO add a graphic which illustrates the connection between the parts
	  
	\subsection{parts}
	
	\subsubsection[Fc]{Flight Controller}
	There are two different kind of flight controller the All-in-one(AIO) and just a Fc. The AIO is not only a Fc but also the ESC in one piece. This has the advantage of only needing one board instead of two or five. However if only parts of the ESC or the Fc are damaged you need to replace the whole board which is more expensive than replacing only the Fc or ESC. 
	
	Betaflight and INAV both support a wide variety of Fcs compared to Ardupilot which is only supporting a very specific sample of boards\cite{FcSupport}. They have the option of open and closed hardware. Because the open hardware Fcs are quite expensive, so I decided to go with a closed one. The chip used in Fcs is usually a STM32. There are multiple generations of it the mainly used ones are F4, F7 and H7. The F7 and H7 are much faster than the F4 chips so the decision was not that difficult to make. I then decided to go with the Kakute H7 v1.3 (MPU6000)\cite{KakuteH7} from Holybro, because it was ok in the price and available as a stack. It comes shipped with Betaflight so I will need to flash Ardupilot. 

	\subsubsection[ESC]{Electronic Speed Controler}
	%TODO ESC 
	There are two different kind of ESCs, 4in1 and single ESCs. If you use single ESCs you will need one for each motor instead of a single board for all of them. The advantage of 4in1 ESCs is that you do not need a power distribution board, because it is already incorporated in the ESC, and that it can come in a stack. A stack is a Fc and ESC mounted on top of each other. It normally comes with stack screws. The disadvantage is that if a part of the ESC is damaged you need to replace the whole board. What needs to be looked upon buying a ESC is that the peak current of the motor is not higher than the burst current of the ESC, because it could damage a two high current could damage the ESC.
	
	My decision was to go with a 4in1 on a stack, because it is slightly cheaper and normally easier to wire. The only option with the Kakute H7 was the stack with the Tekko32 4in1 with a continuous current of either 50, 60 or 65 Ampere. I chose the 50A\cite{Tekko32} one, because you do not need a high continuous current rating when flying rather slowly and the motors I chose have a peak current of around 42A. 
	
	At the time I bought the ESC it was still shipped with BLHeli32 which as mentioned has seized their operations. I could however flash AM32 onto it.

	\subsubsection{Motor}
	
	\subsubsection{Battery}
	
	
	\subsubsection{GNSS(Global Navigation Satellite System)}
	% TODO GNSS/Compass
	Micro M10 from Holybro choosen, because it is from the same manufacturer as the Fc.
	4 Concurrent GPS
	CEP of 2 m(short explanation box)
	connects via Uart
	\\ built-in compass connects to the Fc with a I2C protocol...
	
	
	

	\subsubsection{Transmitter Protocols}
	\subsubsection*{Elrs}
	\subsubsection*{Frsky}
	\subsubsection*{Crossfire TX}
	
	\subsubsection{Data Transfer Protocols}
	\subsubsection*{SPI}
	\subsubsection*{Uart}
	\subsubsection*{I2C}
	
	\subsubsection{Radio/Transmitter}
	%TODO Radio/Transmitter
	you can play games on the Boxer Radio
		

	\subsubsection{Smoke Stopper}
	A part that stops the ESC from short circuiting due to wrongly soldered parts. It is there to prevent the part getting destroyed. There are two groups of it one that you buy and gets destroyed when the ESC short circuits instead of the ESC and it saves you money by not destroying the ESC and sacrificing itself. There is another category that does not destroy itself and there are also some that you can solder together on your own. These work by using a lamp(Gl√ºhbirne).
	
	\subsubsection{Problems with the Parts}
	% TODO Problems
	There were two problems that arose one less severe than the other. One problem was that my ordered Kakute-Tekko stack did not include stack screws, which they normally do. Stack screws are just screws that you can use to mount the stack onto the frame. So I needed to purchase them separately.
	% the batteries from aliexpress were not delivered instead I received insect traps
	
	
	
	
	\subsection{soldering}
	
	\subsection{ardupilot}
	The following was based on the Ardupilot documentation
	\subsubsection{Ground Station}
	\textbf{ground station} = software running on ground-based computer, transmit data to the UAV and can control it
	\begin{itemize}
		\item \textbf{Mission Planner} \cite{MissionPlanner} widely used and has a wiki(Open Source)
		\begin{itemize}
			\item 
		\end{itemize}
		\item \textbf{Mavproxy}, for Linux used for code developers, written in Python(Open Source)
		\item some considerations for Smartphone (might be useful for connection between Raspi and ground)
	\end{itemize}
	downloading of latest stable Ardupilot firmware \cite{ArduPilotFirmware} for Kakute H7 fc	
	
	loading Ardupilot firmware onto Fc with STM32 CubeProgrammer by connecting the Fc in DFU(Direct Firmware Update) Mode with the computer(quick explanation box for STM32 and DFU mode)
	
	reconnecting Fc with Comp. 
	opening Mission Planner and connecting to Fc seeing first Yaw measurements 
	\subsubsection{GPS Connection}
	
	Trying to get GPS connection, No GPS message
	changing the GPS\_Type to 2 for Ublox GPS... doesn't work
	\\
	\\ Micro M10 probably connected, due to compass being seen on Mission Planner, was however unable to calibrate it
	\\
	\\ soldering might be the problem?-- Should be fine
	\\ blinking blue LED indicates no satellite fix... did blink in- and outside
	\\ cables are also connected correctly
	\\
	\\ Lots of questions... So theoretically my GPS should be connected, but the Fc does not recognize it, however it recognizes the compass from the GPS module???
	\\
	\\ The problem was that the \lstinline|Serial3_Protocol|(Which is for the Uart3) was set to 5 which meant GPS, however I will be needing the Uart3 for the Raspi and not a GPS and so it blocked the Uart4 which was also set to GPS. Not it finally works.
	\subsubsection{Receiver/Transmitter}
	changing RC\_optopns to 420 k baudrate for Elrs
	\\ connection between the receiver and radio exist... radio says telemetry recovered and receiver isn't flashing a green light anymore, but has a constant blue light. However no connection to Fc yet.
	\\ followed the page (reference to expresslrs.org page) it does not work yet. 
	\\ could change the receiver to the uart1 which is usually for the receiver, but it would require an JHSt thingy and more soldering
	\\
	\\ it works now... I needed to set Brd\_Alt\_Config to 1, which is a Fc specific parameter and I found it in the kakute H7 section which said that it needed to be done
	\subsubsection*{Battery/Servos/Smoke Stopper/Compass Calibration}
	pluging in battery with smoke stopper attached, smoke stopper does not light up
	\\changing the battery settings for the tekko32 F4 4 in 1 Esc as explained in the kakute h7 fc page of ardupilot only needed to change the BATT\_MONITOR ot 4 all the others were already correct, I can see now the voltage and the Amperage of the battery
	\\the only thing missing before I can arm it is the compass calibration...(note: I'm inside so the GNSS has no connection but it works as soon as I get under the free sky.)
	\\ compass calibration fails multiple times.. even tried changing it as the docs from holybro suggest compass\_ortient= 6 still does not work. 
	\\ turns out you need good GPS lock to do it...I'm inside
	\\with GPS lock and outside with relaxed settings and both compass\_orient =6 and 0 it does not work
	the failure could be caused by the computer which is nearby or the table which is metal on which I've done it. 
	There could also be the fix by doing the largevehicle Magcal, which helped a person online who also had a 5 inch copter. 
	\\ somehow it calibrated??? I tried to calibrate it multiple times in different settings and it never worked and without even being able to finish my last try at calibration it worked??? it might have been the largevehical magcal that has done it...
	\\
	\\ Motor testing works after connecting assigning the right position to the motors and setting the mot\_pwm\_type to dshot 600
	\\new error message: battery failsafe, begins to continously beep(but not always???) might be caused from the connection to the computer... so that it will take the wrong power input as main power
	\\ the motors suddenly began to beep I have no idea why
	\\ I got the error compass variance, but when I move further away from my computer it goes away.
	\\ all prearm checks are gone now except magfield
	\\ magfield problems went away after positioning the drone further away from the computer... now there is no prearm check(you can also disable them by setting arming\_check to 0) that needs to be done and I can arm the drone
	\\ only problem is that I don't now how... I was able to assign the rc channel 5 to it. 
	\\ disabling arming check... however the MAV rejects the forece arm command. 
	\\ arming worked via radio and MP after I disabled the Geofence that I put in somewhen earlier, even though I disabled arming\_check the geofence did not get disabled.
	\\ I can do it without mission planner, but the Fc does not get any power from the esc... it might be, because I have connection between the Fc and Esc in the second slot. It was only a bad connection between the Fc and ESC nothing about the slot I put them in. 
	\\ bench testing with propellers... I hit one of the receiver antennas with a prop it fell off I was able to easily attach it again, however I'm not sure if that particular antenna is working now
	\\ new prearm error crashdump bin detected, so through my research I've concluded that the error is currently insignificant, because it was probably caused through my bench testing.
	\\ I was not able to get rid off the error and I will analyse the crash dump file later on somewhen. I just did all the prearm checks except crash dump bin detected and then disabled prearm checks. 
	\\ the drone flew, even though it was only spinning in one direction because two motors currrently spin in the wrong direction.
	\\ the reverse button in MP is not working
	\\ to reverse the motors I need to set servo\_blh\_auto to one and open it in Blhelisuite32\cite{BLHeliSuite32}. By using the reversed mode in Blhelisuite32 I was able to reverse one motor but one that should not be reversed. After trying multiple times I now finally got the A and C motor spinning counter clockwise. 
	\\ it flew really shaky after disabling the arming\_check again it might really be a compass problem again.
	\\ the compass calibration worked correctly after I took the GPS module and put it directly onto the flight controller instead of having it on the frame
	\\ again trying to fly shaking violently and somewhat crashing into the ground.
	\\ tightening everything on the quad... might work
	\\ I tightened everything tried different props, due to damage on the first set and possiblity of inbalanced props in the second set, it still wobbled extremely. 
	\\ then I came to the conclusion through different websites that my PID values are wrong and it turns out they actually were and I needed to change my parameters from a 9 inch drone to a 5 inch.
	\\ it flew well, however I still need to invert the switches from the radio, because it currently goes into the wrong direction when I steer left it goes right and vice versa. 
	
	
	
	
	
	\section{Results}
	\section{Discussion and Outlook}
	\section{Conclusion}
	
	\section{References}
	\printbibliography[
	heading=bibintoc,
	title={Bibliography}
	]	
	\section{Table of Figures}
	\comment{(short table on which every figure description with the page number is listed)}
\end{document}
